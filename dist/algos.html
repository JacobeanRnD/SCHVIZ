<!DOCTYPE html>
<meta charset="utf-8">
<style>
html, body { height: 100%; margin: 0; }
#controls { float: left; display: none; width: 100%; }
.visbox { float: left; width: 400px; height: 400px; border: 1px solid #888; position: relative; }
.visbox > h2 { position: absolute; margin: 0; }
.visbox > .closebutton { position: absolute; right: 0; }
</style>
<link rel="stylesheet" href="forceLayout.css">
<body>
<div id="controls">
  <label>Force layout <input type=checkbox name=force></label>
  <label>Text-on-path <input type=checkbox name=textOnPath></label>
  <label>Kieler algorithm <select name=algorithm></select></label>
  <label>Example document <select name=document></select></label>
</div>
<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/q/q.js"></script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/backbone/backbone.js"></script>
<script src="bower_components/async/lib/async.js"></script>
<script src="bower_components/klayjs/klay.js"></script>
<script src="forceLayout.js"></script>
<script>
  (function(){'use strict';
    var debug = (window.location.search.indexOf('debug=on') > -1);
    var exBase = 'https://dl.dropboxusercontent.com/u/103063/static/desm-devel/';
    var $forceCheckbox = $('#controls [name=force]');
    var $textOnPathCheckbox = $('#controls [name=textOnPath]');
    var $algoSelect = $('#controls [name=algorithm]');
    var $docSelect = $('#controls [name=document]');
    var controls = _.extend({}, Backbone.Events);
    var defaultAlgorithm = 'de.cau.cs.kieler.klay.layered';
    var doc = null;
    var algoMap = {};
    var config = {file: 'helloworld.xml', cells: [], force: false, textOnPath: false};
    try { config = JSON.parse(window.location.hash.slice(1)); } catch(e) {}

    $forceCheckbox.change(function() {
      config.force = $forceCheckbox.is(':checked');
      controls.trigger('force');
      saveConfig();
    });
    if(config.force) {
      $forceCheckbox.attr('checked', true);
    }

    $textOnPathCheckbox.change(function() {
      config.textOnPath = $textOnPathCheckbox.is(':checked');
      controls.trigger('textOnPath');
      saveConfig();
    });
    if(config.textOnPath) {
      $textOnPathCheckbox.attr('checked', true);
    }

    $docSelect.change(docChange);

    $algoSelect.change(function() {
      var algorithm = $algoSelect.val();
      createCell(algorithm);
      $algoSelect.val('__new');
      config.cells.push(algorithm);
      saveConfig();
    });

    $.get('http://kieler.herokuapp.com/layout/serviceData', function(resp) {
      var algorithmList = ([]).concat(
        resp.layoutAlgorithms,
        [{id: '__klayjs', name: "KLayJS"}]
      );
      algorithmList.forEach(function(alg) {
        algoMap[alg.id] = alg.name;
      });
      $algoSelect.append(
        '<option disabled selected value="__new">create cell with layout ...</option>',
        algorithmList.map(function(alg) {
          return $('<option>')
              .text(alg.name)
              .attr('value', alg.id);
        })
      );
      $.getJSON(exBase + 'index.json', function(index) {
        $docSelect.append(
          index.examples.map(function(ex) {
            return $('<option>')
                .text(ex.name)
                .attr('value', ex.filename)
                .attr('selected', ex.filename == config.file ? true : null)
          })
        );
        $('#controls').show();
        config.cells.forEach(createCell);
        docChange();
      });
    });

    function saveConfig() {
      window.location.hash = JSON.stringify(config);
    }

    function docChange() {
      config.file = $docSelect.val();
      saveConfig();
      $.get(exBase + config.file, function(resp) {
        doc = resp;
        controls.trigger('doc');
      });
    }

    function createCell(algorithm) {
      var layout;
      var $container = $('<div class="visbox">').appendTo($('body'));
      $('<h2>').text(algoMap[algorithm]).appendTo($container);
      $('<div class="closebutton">')
        .append('[', $('<a>').text('x').click(close), ']')
        .appendTo($container);

      if(doc) createLayout();
      controls.on('force', onForce);
      controls.on('doc', recreate);
      controls.on('textOnPath', recreate);

      function close() {
        controls.off('force', onForce);
        controls.off('doc', recreate);
        controls.off('textOnPath', recreate);
        destroyLayout();
        $container.remove();
        config.cells.splice(config.cells.indexOf(algorithm), 1);
        saveConfig();
      }

      function createLayout() {
        layout = new forceLayout.Layout({
            kielerAlgorithm: algorithm,
            parent: $container[0],
            doc: doc,
            textOnPath: config.textOnPath || false,
            debug: debug
          });
        layout.initialized
          .catch(function(err) {
            console.log(err);
            $(layout.el).replaceWith("Error: " + err.message);
          })
          .done();
        if(config.force) { layout.start(); }
      }

      function destroyLayout() {
        if(layout) { layout.stop(); $(layout.el).remove(); }
      }

      function recreate() {
        destroyLayout();
        createLayout();
      }

      function onForce() {
        if(config.force) { layout.start(); } else { layout.stop(); }
      }
    }
  })();
</script>
