<!DOCTYPE html>
<meta charset="utf-8">
<style>
html, body { height: 100%; margin: 0; }
#controls { float: left; display: none; width: 100%; }
.visbox { float: left; width: 400px; height: 400px; border: 1px solid #888; position: relative; }
.visbox > h2 { position: absolute; margin: 0; }
.visbox > .closebutton { position: absolute; right: 0; }
.visbox.maximized { position: absolute; height: 90%; width: 98%; top: 5%; left: 1%; background: white; z-index: 1; }
</style>
<link rel="stylesheet" href="forceLayout.css">
<body>
<div id="controls">
  <label>Force layout <input type=checkbox name=force></label>
  <label>Text-on-path <input type=checkbox name=textOnPath></label>
  <label>Edge routing <select name=routing></select></label>
  <label>Kieler algorithm <select name=algorithm></select></label>
  <label>Example document <select name=document></select></label>
</div>
<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/q/q.js"></script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/backbone/backbone.js"></script>
<script src="bower_components/async/lib/async.js"></script>
<script src="bower_components/klayjs/klay.js"></script>
<script src="forceLayout.js"></script>
<script>
  (function(){'use strict';
    var debug = (window.location.search.indexOf('debug=on') > -1);
    var exBase = 'https://dl.dropboxusercontent.com/u/103063/static/desm-devel/';
    var $forceCheckbox = $('#controls [name=force]');
    var $textOnPathCheckbox = $('#controls [name=textOnPath]');
    var $routingSelect = $('#controls [name=routing]');
    var $algoSelect = $('#controls [name=algorithm]');
    var $docSelect = $('#controls [name=document]');
    var controls = _.extend({}, Backbone.Events);
    var defaultAlgorithm = 'de.cau.cs.kieler.klay.layered';
    var doc = null;
    var exMap = {};
    var config = {
      algo: '__klayjs',
      cells: [],
      force: false,
      textOnPath: false,
      routing: 'ORTHOGONAL'
    };
    try { config = JSON.parse(window.location.hash.slice(1)); } catch(e) {}

    $forceCheckbox.change(function() {
      config.force = $forceCheckbox.is(':checked');
      controls.trigger('force');
      saveConfig();
    });
    if(config.force) {
      $forceCheckbox.attr('checked', true);
    }

    $textOnPathCheckbox.change(function() {
      config.textOnPath = $textOnPathCheckbox.is(':checked');
      controls.trigger('textOnPath');
      saveConfig();
    });
    if(config.textOnPath) {
      $textOnPathCheckbox.attr('checked', true);
    }

    var routingOptions = [
      {name: "Orthogonal", value: "ORTHOGONAL"},
      {name: "Polyline", value: "POLYLINE"},
      {name: "Splines", value: "SPLINES"}
    ];

    $routingSelect.append(
      routingOptions.map(function(r) {
        return $('<option>')
            .text(r.name)
            .attr('value', r.value)
            .attr('selected', r.value == config.routing ? true : null)
      })
    );

    $routingSelect.change(recreateLayout);
    $algoSelect.change(recreateLayout);

    $docSelect.change(function() {
      var filename = $docSelect.val();
      createCell(filename);
      $docSelect.val('__new');
      config.cells.push(filename);
      saveConfig();
    });

    $.get('http://kieler.herokuapp.com/layout/serviceData', function(resp) {
      var category = {};
      resp.categories.forEach(function(alg) { category[alg.id] = alg.name });
      var algorithmList = ([]).concat(
        resp.layoutAlgorithms.map(function(alg) {
          alg.name = alg.name + " (" + category[alg.category] + ")";
          return alg;
        }),
        [{id: '__klayjs', name: "KLayJS"}]
      );
      $algoSelect.append(
        algorithmList.map(function(alg) {
          return $('<option>')
              .text(alg.name)
              .attr('title', alg.description)
              .attr('value', alg.id)
              .attr('selected', alg.id == config.algo ? true : null)
        })
      );
      $.getJSON(exBase + 'index.json', function(index) {
        index.examples.forEach(function(alg) {
          exMap[alg.filename] = alg.name;
        });
        $docSelect.append(
          '<option disabled selected value="__new">create cell with document ...</option>',
          index.examples.map(function(ex) {
            return $('<option>')
                .text(ex.name)
                .attr('value', ex.filename);
          })
        );
        $('#controls').show();
        config.cells.forEach(createCell);
        recreateLayout();
      });
    });

    function saveConfig() {
      window.location.hash = JSON.stringify(config);
    }

    function recreateLayout() {
      config.routing = $routingSelect.val();
      config.algo = $algoSelect.val();
      saveConfig();
      controls.trigger('recreate');
    }

    function createCell(filename) {
      var $container = $('<div class="visbox">').appendTo($('body'));
      $.get(exBase + filename, function(doc) {
        var layout;
        $('<h2>').text(exMap[filename]).appendTo($container);
        $('<div class="closebutton">')
          .append('[', $('<a>').text('<->').click(zoom), ']')
          .append('[', $('<a>').text('x').click(close), ']')
          .appendTo($container);

        createLayout();
        controls.on('force', onForce);
        controls.on('recreate', recreate);
        controls.on('textOnPath', recreate);

        $(window).resize(function() { layout.invalidateSize(); });

        function close() {
          controls.off('force', onForce);
          controls.off('recreate', recreate);
          controls.off('textOnPath', recreate);
          destroyLayout();
          $container.remove();
          config.cells.splice(config.cells.indexOf(filename), 1);
          saveConfig();
        }

        function zoom() {
          $container.toggleClass('maximized');
          layout.invalidateSize();
        }

        function createLayout() {
          layout = new forceLayout.Layout({
              kielerAlgorithm: config.algo,
              parent: $container[0],
              doc: doc,
              textOnPath: config.textOnPath || false,
              routing: config.routing,
              debug: debug
            });
          layout.initialized
            .catch(function(err) {
              console.error(err);
              $(layout.el).replaceWith("Error: " + err.message);
            })
            .done();
          if(config.force) { layout.start(); }
        }

        function destroyLayout() {
          layout.stop();
          $(layout.el).remove();
        }

        function recreate() {
          destroyLayout();
          createLayout();
        }

        function onForce() {
          if(config.force) { layout.start(); } else { layout.stop(); }
        }
      });
    }
  })();
</script>
