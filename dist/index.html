<!DOCTYPE html>
<meta charset="utf-8">
<style>
html, body { height: 100%; margin: 0; }
#controls { position: fixed; display: none; }
</style>
<link rel="stylesheet" href="forceLayout.css">
<body>
<div id="controls">
  <label>Force layout <input type=checkbox name=force></label>
  <label>Kieler algorithm <select name=algorithm></select></label>
</div>
<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/q/q.js"></script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/backbone/backbone.js"></script>
<script src="bower_components/async/lib/async.js"></script>
<script src="bower_components/klayjs/klay.js"></script>
<script src="forceLayout.js"></script>
<script>
  (function(){'use strict';
    var debug = (window.location.search.indexOf('debug=on') > -1);
    var $forceCheckbox = $('#controls [name=force]');
    var $algoSelect = $('#controls [name=algorithm]')
    var controls = _.extend({}, Backbone.Events);
    var useForceLayout = false;
    var defaultAlgorithm = 'de.cau.cs.kieler.klay.layered';
    var algorithm = localStorage.getItem('desm-layout-algorithm') || defaultAlgorithm;
    $forceCheckbox.change(function() {
      useForceLayout = $forceCheckbox.is(':checked');
      localStorage.setItem('desm-force-layout', useForceLayout || '');
      controls.trigger('force', useForceLayout);
    });
    if(localStorage.getItem('desm-force-layout')) {
      $forceCheckbox.attr('checked', useForceLayout = true);
    }
    $.get('http://kieler.herokuapp.com/layout/serviceData', function(resp) {
      $algoSelect.append(
        resp.layoutAlgorithms.map(function(alg) {
          return $('<option>')
              .text(alg.name)
              .attr('value', alg.id)
              .attr('selected', alg.id === algorithm);
        })
      );
      $algoSelect.change(function() {
        algorithm = $algoSelect.val();
        localStorage.setItem('desm-layout-algorithm', algorithm);
        controls.trigger('algorithm', algorithm);
      });
      ready();
    });

    function invokeLayout(options) {
      var layout;
      function createLayout() {
        layout = new forceLayout.Layout(_.extend({
            kielerAlgorithm: algorithm,
            debug: debug
          }, options));
        window.layout = layout;
        if(useForceLayout) { layout.start(); }
      }
      createLayout();
      controls.on('force', function(start) {
        if(start) { layout.start(); } else { layout.stop(); }
      });
      controls.on('algorithm', function() {
        layout.stop();
        $(layout.el).remove();
        createLayout();
      });
      return layout;
    }


    function demo(tree) {
      var parent = $('<div style="width:400px;height:400px;float:left">')[0];
      $('body').append(parent);
      invokeLayout({parent: parent, tree: tree});
    };


    function ready() {
      var filem = window.location.search.match(/file=([^&]*)/) || [];
      var file = filem[1];
      var edit = window.location.search.indexOf('edit=on') > -1;

      $('#controls').show();

      if(edit) {
        editDemo(file);
      }
      else if(file) {
        fileDemo(file);
      }
      else {
        staticDemo();
      }
    }

    function fileDemo(file) {
      $.get(file, function(resp) {
        invokeLayout({parent: $('body')[0], doc: resp});
      });
    }

    function editDemo(file) {
      var parent = $('<div style="width:45%;height:95%;float:right">')[0];
      var $src = $('<textarea>').css({width: '45%', height: '80%', 'margin-top': '20px'});
      var $update = $('<button>').text('update').click(update);
      var $reset = $('<button>').text('reset').click(reset);
      var $saveGeom = $('<button>').text('save geometry').click(saveGeom);
      var $clearGeom = $('<button>').text('clear geometry').click(clearGeom);
      var layout;
      $('body').append(parent, $src, '<br>', $update, $reset, $saveGeom, $clearGeom);

      if(file) {
        $.get(file, function(_r, _s, req) {
          $src.val(req.responseText);
          layout = invokeLayout({
            parent: parent,
            doc: parse(req.responseText),
            geometry: localStorage.getItem('desm-geometry')
          });
        });
      }

      function parse(src) {
        var parser = new window.DOMParser();
        return parser.parseFromString($src.val(), 'text/xml');
      }

      function update() {
        layout.update(parse($src.val()));
      }

      function reset() {
        layout.stop();
        $(layout.el).remove();
        layout = invokeLayout({parent: parent, doc: parse()});
      }

      function saveGeom() {
        var geom = layout.saveGeometry();
        localStorage.setItem('desm-geometry', geom);
      }

      function clearGeom() {
        localStorage.removeItem('desm-geometry');
      }
    }

    function staticDemo() {
      demo([
        {id: "A"},
        {id: "B"},
        {id: "C"},
        {id: "D"},
        {id: "E"},
        {id: "F"}
      ]);


      demo([
        {id: "A", children: [
          {id: "A1", transitions: [{target: "A2", event: "a1->a2", cond: "foo"}]},
          {id: "A2", transitions: [{target: "A3", event: "a2->a3", cond: "bar"}]},
          {id: "A3", transitions: [{target: "A1", event: "a2->a1", cond: "baz"}]}
        ], transitions: [{target: "B"}]},
        {id: "B", children: [
          {id: "B1", transitions: [{target: "B2"}]},
          {id: "B2", transitions: [{target: "B3"}]},
          {id: "B3", transitions: [{target: "B1"}]}
        ], transitions: [{target: "C"}]},
        {id: "C", children: [
          {id: "C1", transitions: [{target: "C2"}]},
          {id: "C2", transitions: [{target: "C3"}]},
          {id: "C3", transitions: [{target: "C1"}]}
        ], transitions: [{target: "A"}]}
      ]);


      demo([
        {id: "A", children: [
          {id: "B", children: [
            {id: "C", children: [
              {id: "D", children: [
                {id: "E", children: [
                  {id: "F", children: [
                    {id: "G", children: [
                      {id: "H"}
                    ]}
                  ]}
                ]}
              ]}
            ]}
          ]}
        ]}
      ]);


      demo([
        {id: "A", children: [
          {id: "B1", children: [
            {id: "C11"},
            {id: "C12"}
          ]},
          {id: "B2", children: [
            {id: "C21"},
            {id: "C22"}
          ]}
        ]}
      ]);


      demo([
        {id: "O", children: [
          {id: "A"},
          {id: "B"},
          {id: "C"},
          {id: "D"},
          {id: "E"},
          {id: "F"},
          {id: "X", transitions: [
            {target: "A"},
            {target: "B"},
            {target: "C"},
            {target: "D"},
            {target: "E"},
            {target: "F"}
          ]}
        ]}
      ]);


      demo([
        {id: "A", children: [
          {id: "A1", transitions: [{target: "B1"}]},
          {id: "A2", transitions: [{target: "B2"}]},
        ], transitions: [{target: "B"}]},
        {id: "B", children: [
          {id: "B1", transitions: [{target: "C1"}]},
          {id: "B2", transitions: [{target: "C2"}]},
        ], transitions: [{target: "C"}]},
        {id: "C", children: [
          {id: "C1", transitions: [{target: "A1"}]},
          {id: "C2", transitions: [{target: "A2"}]},
        ], transitions: [{target: "A"}]},
      ]);
    }
  })();
</script>
