<!DOCTYPE html>
<meta charset="utf-8">
<style>
html, body { height: 100%; margin: 0; }
#controls { position: fixed; display: none; }
</style>
<link rel="stylesheet" href="forceLayout.css">
<body>
<div id="controls">
  <label>Force layout <input type=checkbox name=force></label>
  <label>Kieler algorithm <select name=algorithm></select></label>
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/q.js/1.1.2/q.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
<script src="forceLayout.js"></script>
<script>
  (function(){'use strict';
    var m = window.location.search.match(/file=([^&]*)/) || [];
    var debug = (window.location.search.indexOf('debug=on') > -1);
    var file = m[1];
    var $forceCheckbox = $('#controls [name=force]');
    var $algoSelect = $('#controls [name=algorithm]')
    var controls = _.extend({}, Backbone.Events);
    var useForceLayout = false;
    var defaultAlgorithm = 'de.cau.cs.kieler.klay.layered';
    var algorithm = localStorage.getItem('desm-layout-algorithm') || defaultAlgorithm;
    $forceCheckbox.change(function() {
      useForceLayout = $forceCheckbox.is(':checked');
      localStorage.setItem('desm-force-layout', useForceLayout || '');
      controls.trigger('force', useForceLayout);
    });
    if(localStorage.getItem('desm-force-layout')) {
      $forceCheckbox.attr('checked', useForceLayout = true);
    }
    $.get('/kieler/menu', function(resp) {
      $algoSelect.append(
        resp.layoutAlgorithms.map(function(alg) {
          return $('<option>')
              .text(alg.name)
              .attr('value', alg.id)
              .attr('selected', alg.id === algorithm);
        })
      );
      $algoSelect.change(function() {
        algorithm = $algoSelect.val();
        localStorage.setItem('desm-layout-algorithm', algorithm);
        controls.trigger('algorithm', algorithm);
      });
      ready();
    });

    function invokeLayout(options) {
      var layout;
      function createLayout() {
        layout = new forceLayout.Layout(_.extend({
            kielerURL: '/kieler/layout',
            kielerAlgorithm: algorithm,
            debug: debug
          }, options));
        window.layout = layout;
        if(useForceLayout) { layout.start(); }
      }
      createLayout();
      controls.on('force', function(start) {
        if(start) { layout.start(); } else { layout.stop(); }
      });
      controls.on('algorithm', function() {
        layout.stop();
        $(layout.el).remove();
        createLayout();
      });
    }


    function demo(tree) {
      var parent = $('<div style="width:400px;height:400px;float:left">')[0];
      $('body').append(parent);
      invokeLayout({parent: parent, tree: tree});
    };


    function ready() {
      $('#controls').show();

      if(file) {
        $.get(file, function(resp) {
          invokeLayout({parent: $('body')[0], doc: resp});
        });
        return;
      }


      demo([
        {id: "A"},
        {id: "B"},
        {id: "C"},
        {id: "D"},
        {id: "E"},
        {id: "F"}
      ]);


      demo([
        {id: "A", children: [
          {id: "A1", transitions: [{target: "A2", event: "a1->a2", cond: "foo"}]},
          {id: "A2", transitions: [{target: "A3", event: "a2->a3", cond: "bar"}]},
          {id: "A3", transitions: [{target: "A1", event: "a2->a1", cond: "baz"}]}
        ], transitions: [{target: "B"}]},
        {id: "B", children: [
          {id: "B1", transitions: [{target: "B2"}]},
          {id: "B2", transitions: [{target: "B3"}]},
          {id: "B3", transitions: [{target: "B1"}]}
        ], transitions: [{target: "C"}]},
        {id: "C", children: [
          {id: "C1", transitions: [{target: "C2"}]},
          {id: "C2", transitions: [{target: "C3"}]},
          {id: "C3", transitions: [{target: "C1"}]}
        ], transitions: [{target: "A"}]}
      ]);


      demo([
        {id: "A", children: [
          {id: "B", children: [
            {id: "C", children: [
              {id: "D", children: [
                {id: "E", children: [
                  {id: "F", children: [
                    {id: "G", children: [
                      {id: "H"}
                    ]}
                  ]}
                ]}
              ]}
            ]}
          ]}
        ]}
      ]);


      demo([
        {id: "A", children: [
          {id: "B1", children: [
            {id: "C11"},
            {id: "C12"}
          ]},
          {id: "B2", children: [
            {id: "C21"},
            {id: "C22"}
          ]}
        ]}
      ]);


      demo([
        {id: "O", children: [
          {id: "A"},
          {id: "B"},
          {id: "C"},
          {id: "D"},
          {id: "E"},
          {id: "F"},
          {id: "X", transitions: [
            {target: "A"},
            {target: "B"},
            {target: "C"},
            {target: "D"},
            {target: "E"},
            {target: "F"}
          ]}
        ]}
      ]);


      demo([
        {id: "A", children: [
          {id: "A1", transitions: [{target: "B1"}]},
          {id: "A2", transitions: [{target: "B2"}]},
        ], transitions: [{target: "B"}]},
        {id: "B", children: [
          {id: "B1", transitions: [{target: "C1"}]},
          {id: "B2", transitions: [{target: "C2"}]},
        ], transitions: [{target: "C"}]},
        {id: "C", children: [
          {id: "C1", transitions: [{target: "A1"}]},
          {id: "C2", transitions: [{target: "A2"}]},
        ], transitions: [{target: "A"}]},
      ]);
    }
  })();
</script>
